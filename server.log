nohup: ignoring input
=> Booting Puma
=> Rails 8.0.2 application starting in development 
=> Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 6.6.1 ("Return to Forever")
* Ruby version: ruby 3.3.1 (2024-04-23 revision c56cd86388) +YJIT [x86_64-linux]
*  Min threads: 3
*  Max threads: 3
*  Environment: development
*          PID: 296010
* Listening on http://127.0.0.1:3000
* Listening on http://[::1]:3000
Use Ctrl-C to stop
Started GET "/webhooks/brevo/test" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:21:05 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
  [1m[36mActiveRecord::SchemaMigration Load (1.4ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC /*application='DevCrm'*/[0m
Processing by Webhooks::BrevoController#test as */*
Brevo webhook test endpoint accessed
Completed 200 OK in 57ms (Views: 0.2ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)


Started POST "/webhooks/brevo" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:21:16 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
Processing by Webhooks::BrevoController#receive as */*
  Parameters: {"event"=>"delivered", "message-id"=>"test-message-123", "email"=>"[FILTERED]", "date"=>"2025-08-16T17:21:15.000Z", "brevo"=>{"event"=>"delivered", "message-id"=>"test-message-123", "email"=>"[FILTERED]", "date"=>"2025-08-16T17:21:15.000Z"}}
=== Brevo Webhook Received ===
Headers: {"HTTP_HOST"=>"63158f801242.ngrok-free.app", "HTTP_USER_AGENT"=>"curl/7.81.0", "HTTP_ACCEPT"=>"*/*", "HTTP_NGROK_SKIP_BROWSER_WARNING"=>"true", "HTTP_X_FORWARDED_FOR"=>"2a02:c7c:36b6:a200:efb9:106c:711b:cb24", "HTTP_X_FORWARDED_HOST"=>"63158f801242.ngrok-free.app", "HTTP_X_FORWARDED_PROTO"=>"https", "HTTP_ACCEPT_ENCODING"=>"gzip", "HTTP_VERSION"=>"HTTP/1.1"}
Body: {
    "event": "delivered",
    "message-id": "test-message-123",
    "email": "test@example.com",
    "date": "2025-08-16T17:21:15.000Z"
  }
Content-Type: application/json
=================================
Parsed payload: {"event"=>"delivered", "message-id"=>"test-message-123", "email"=>"test@example.com", "date"=>"2025-08-16T17:21:15.000Z"}
Extracted message_id: test-message-123 from payload keys: ["event", "message-id", "email", "date"]
Processing delivered event for message_id: test-message-123
  [1m[36mMessage Load (1.7ms)[0m  [1m[34mSELECT "messages".* FROM "messages" WHERE "messages"."provider_message_id" = 'test-message-123' LIMIT 1 /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:82:in `handle_delivered_event'
Message with provider_message_id test-message-123 not found
  [1m[36mMessage Pluck (0.5ms)[0m  [1m[34mSELECT "messages"."provider_message_id", "messages"."id" FROM "messages" /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:89:in `handle_delivered_event'
Available message IDs: [["<202508161715.88026029640@smtp-relay.mailin.fr>", 39], ["<202508161715.55626208067@smtp-relay.mailin.fr>", 40], ["<202508150254.53064837256@smtp-relay.mailin.fr>", 1], ["<202508150254.17768029360@smtp-relay.mailin.fr>", 2], ["<202508150254.77199519851@smtp-relay.mailin.fr>", 3], ["<202508150254.19594489939@smtp-relay.mailin.fr>", 4], ["<202508150254.72826429403@smtp-relay.mailin.fr>", 5], ["<202508150254.87516717831@smtp-relay.mailin.fr>", 6], ["<202508150254.76316601562@smtp-relay.mailin.fr>", 7], ["<202508150254.53971778581@smtp-relay.mailin.fr>", 8], ["<202508150301.20110419894@smtp-relay.mailin.fr>", 9], ["<202508150301.13355024695@smtp-relay.mailin.fr>", 10], ["<202508150301.71406161462@smtp-relay.mailin.fr>", 11], ["<202508150301.15383079829@smtp-relay.mailin.fr>", 12], ["<202508150301.57707441893@smtp-relay.mailin.fr>", 13], ["<202508150301.34200277776@smtp-relay.mailin.fr>", 14], ["<202508150301.11721689753@smtp-relay.mailin.fr>", 15], ["<202508150301.17772301154@smtp-relay.mailin.fr>", 16], ["<202508160309.72055404018@smtp-relay.mailin.fr>", 21], ["<202508160309.26889540817@smtp-relay.mailin.fr>", 22]]
Completed 200 OK in 116ms (Views: 0.3ms | ActiveRecord: 21.8ms (2 queries, 0 cached) | GC: 0.0ms)


Started POST "/webhooks/brevo" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:22:38 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
Processing by Webhooks::BrevoController#receive as */*
  Parameters: {"event"=>"delivered", "message-id"=>nil, "email"=>"[FILTERED]", "date"=>"2025-08-16T17:22:37Z", "brevo"=>{"event"=>"delivered", "message-id"=>nil, "email"=>"[FILTERED]", "date"=>"2025-08-16T17:22:37Z"}}
=== Brevo Webhook Received ===
Headers: {"HTTP_HOST"=>"63158f801242.ngrok-free.app", "HTTP_USER_AGENT"=>"Ruby", "HTTP_ACCEPT"=>"*/*", "HTTP_ACCEPT_ENCODING"=>"gzip;q=1.0,deflate;q=0.6,identity;q=0.3", "HTTP_NGROK_SKIP_BROWSER_WARNING"=>"true", "HTTP_X_FORWARDED_FOR"=>"2a02:c7c:36b6:a200:efb9:106c:711b:cb24", "HTTP_X_FORWARDED_HOST"=>"63158f801242.ngrok-free.app", "HTTP_X_FORWARDED_PROTO"=>"https", "HTTP_VERSION"=>"HTTP/1.1"}
Body: {"event":"delivered","message-id":null,"email":"ben.patel@orbital.io","date":"2025-08-16T17:22:37Z"}
Content-Type: application/json
=================================
Parsed payload: {"event"=>"delivered", "message-id"=>nil, "email"=>"ben.patel@orbital.io", "date"=>"2025-08-16T17:22:37Z"}
Extracted message_id:  from payload keys: ["event", "message-id", "email", "date"]
Completed 200 OK in 29ms (Views: 0.1ms | ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.2ms)


Started POST "/webhooks/brevo" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:22:50 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
Processing by Webhooks::BrevoController#receive as */*
  Parameters: {"event"=>"delivered", "message-id"=>"<202508150254.53064837256@smtp-relay.mailin.fr>", "email"=>"[FILTERED]", "date"=>"2025-08-16T17:22:49Z", "brevo"=>{"event"=>"delivered", "message-id"=>"<202508150254.53064837256@smtp-relay.mailin.fr>", "email"=>"[FILTERED]", "date"=>"2025-08-16T17:22:49Z"}}
=== Brevo Webhook Received ===
Headers: {"HTTP_HOST"=>"63158f801242.ngrok-free.app", "HTTP_USER_AGENT"=>"curl/7.81.0", "HTTP_ACCEPT"=>"*/*", "HTTP_NGROK_SKIP_BROWSER_WARNING"=>"true", "HTTP_X_FORWARDED_FOR"=>"2a02:c7c:36b6:a200:efb9:106c:711b:cb24", "HTTP_X_FORWARDED_HOST"=>"63158f801242.ngrok-free.app", "HTTP_X_FORWARDED_PROTO"=>"https", "HTTP_ACCEPT_ENCODING"=>"gzip", "HTTP_VERSION"=>"HTTP/1.1"}
Body: {"event": "delivered", "message-id": "<202508150254.53064837256@smtp-relay.mailin.fr>", "email": "alice.smith@acme.co.uk", "date": "2025-08-16T17:22:49Z"}
Content-Type: application/json
=================================
Parsed payload: {"event"=>"delivered", "message-id"=>"<202508150254.53064837256@smtp-relay.mailin.fr>", "email"=>"alice.smith@acme.co.uk", "date"=>"2025-08-16T17:22:49Z"}
Extracted message_id: <202508150254.53064837256@smtp-relay.mailin.fr> from payload keys: ["event", "message-id", "email", "date"]
Processing delivered event for message_id: <202508150254.53064837256@smtp-relay.mailin.fr>
  [1m[36mMessage Load (0.4ms)[0m  [1m[34mSELECT "messages".* FROM "messages" WHERE "messages"."provider_message_id" = '<202508150254.53064837256@smtp-relay.mailin.fr>' LIMIT 1 /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:82:in `handle_delivered_event'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:84:in `handle_delivered_event'
  [1m[36mMessage Update (0.8ms)[0m  [1m[33mUPDATE "messages" SET "status" = 5, "updated_at" = '2025-08-16 17:22:50.102654' WHERE "messages"."id" = 1 /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:84:in `handle_delivered_event'
  [1m[36mTRANSACTION (9.4ms)[0m  [1m[35mCOMMIT /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:84:in `handle_delivered_event'
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mBEGIN /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:212:in `create_message_event'
  [1m[36mMessageEvent Create (2.6ms)[0m  [1m[32mINSERT INTO "message_events" ("message_id", "event_type", "occurred_at", "raw", "created_at", "updated_at") VALUES (1, 0, '2025-08-16 17:22:49', '{"event":"delivered","message-id":"\u003c202508150254.53064837256@smtp-relay.mailin.fr\u003e","email":"alice.smith@acme.co.uk","date":"2025-08-16T17:22:49Z"}', '2025-08-16 17:22:50.147915', '2025-08-16 17:22:50.147915') RETURNING "id" /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:212:in `create_message_event'
  [1m[36mTRANSACTION (2.0ms)[0m  [1m[35mCOMMIT /*action='receive',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:212:in `create_message_event'
Created message event 1 for message 1: delivered
Message 1 marked as delivered
Completed 200 OK in 127ms (Views: 0.1ms | ActiveRecord: 28.1ms (3 queries, 0 cached) | GC: 1.1ms)


Started GET "/webhooks/brevo/status" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:23:46 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
Processing by Webhooks::BrevoController#status as */*
  [1m[36mMessageEvent Count (0.5ms)[0m  [1m[34mSELECT COUNT(*) FROM "message_events" WHERE (created_at > '2025-08-16 16:23:46.625659') /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:26:in `status'
  [1m[36mMessageEvent Load (0.8ms)[0m  [1m[34mSELECT "message_events".* FROM "message_events" ORDER BY "message_events"."created_at" ASC LIMIT 10 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:27:in `map'
  [1m[36mMessage Load (0.5ms)[0m  [1m[34mSELECT "messages".* FROM "messages" WHERE "messages"."status" IN (5, 4, 3) LIMIT 5 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:36:in `map'
  [1m[36mContact Load (1.0ms)[0m  [1m[34mSELECT "contacts".* FROM "contacts" WHERE "contacts"."id" = 1 LIMIT 1 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:39:in `block in status'
Completed 200 OK in 164ms (Views: 0.3ms | ActiveRecord: 24.1ms (4 queries, 0 cached) | GC: 2.4ms)


Started GET "/webhooks/brevo/status" for 2a02:c7c:36b6:a200:efb9:106c:711b:cb24 at 2025-08-16 18:25:08 +0100
Cannot render console from 2a02:c7c:36b6:a200:efb9:106c:711b:cb24! Allowed networks: 127.0.0.0/127.255.255.255, ::1
Processing by Webhooks::BrevoController#status as */*
  [1m[36mMessageEvent Count (4.7ms)[0m  [1m[34mSELECT COUNT(*) FROM "message_events" WHERE (created_at > '2025-08-16 16:25:08.601826') /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:26:in `status'
  [1m[36mMessageEvent Load (0.5ms)[0m  [1m[34mSELECT "message_events".* FROM "message_events" ORDER BY "message_events"."created_at" ASC LIMIT 10 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:27:in `map'
  [1m[36mMessage Load (0.5ms)[0m  [1m[34mSELECT "messages".* FROM "messages" WHERE "messages"."status" IN (5, 4, 3) LIMIT 5 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:36:in `map'
  [1m[36mContact Load (0.7ms)[0m  [1m[34mSELECT "contacts".* FROM "contacts" WHERE "contacts"."id" = 1 LIMIT 1 /*action='status',application='DevCrm',controller='brevo'*/[0m
  â†³ app/controllers/webhooks/brevo_controller.rb:39:in `block in status'
Completed 200 OK in 75ms (Views: 0.3ms | ActiveRecord: 6.3ms (4 queries, 0 cached) | GC: 0.4ms)


