<% content_for :page_title, "Import Batch Details" %>

<div class="admin-header">
  <div>
    <h1 class="admin-title">Import Batch Details</h1>
    <p class="admin-subtitle"><%= @import_batch.original_filename %></p>
  </div>
  <div class="admin-actions">
    <% if @import_batch.processing? %>
      <%= link_to "Check Status", status_admin_import_path(@import_batch), class: "btn btn-primary" %>
    <% end %>
    <%= link_to "Back to Imports", admin_imports_path, class: "btn btn-secondary" %>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Import Details -->
  <div class="lg:col-span-2">
    <div class="card">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Import Information</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="form-label">Filename</label>
            <p class="text-gray-900"><%= @import_batch.original_filename %></p>
          </div>
          <div>
            <label class="form-label">User</label>
            <p class="text-gray-900"><%= @import_batch.user.email %></p>
          </div>
          <div>
            <label class="form-label">Status</label>
            <p class="text-gray-900">
              <span class="badge badge-<%= 
                case @import_batch.status
                when 'completed' then 'success'
                when 'failed' then 'danger'
                when 'importing', 'validating', 'mapping' then 'warning'
                else 'secondary'
                end
              %>">
                <%= @import_batch.status.humanize %>
              </span>
            </p>
          </div>
          <div>
            <label class="form-label">Progress</label>
            <p class="text-gray-900">
              <% if @import_batch.processing? %>
                <div class="progress-bar mb-2">
                  <div class="progress-fill" style="width: <%= @progress %>%"></div>
                </div>
                <%= @progress %>%
              <% elsif @import_batch.completed? %>
                100%
              <% else %>
                Not started
              <% end %>
            </p>
          </div>
          <div>
            <label class="form-label">Created</label>
            <p class="text-gray-900"><%= @import_batch.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
          <div>
            <label class="form-label">Duration</label>
            <p class="text-gray-900">
              <%= @import_batch.duration || "Not completed" %>
            </p>
          </div>
        </div>

        <% if @import_batch.error_details.present? %>
          <div class="mt-6">
            <label class="form-label">Error Details</label>
            <div class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-red-900 whitespace-pre-wrap"><%= @import_batch.error_details %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Statistics -->
    <div class="card mt-6">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Import Statistics</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-900"><%= @import_batch.total_rows || 0 %></div>
            <div class="text-sm text-gray-600">Total Rows</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600"><%= @import_batch.imported_count || 0 %></div>
            <div class="text-sm text-gray-600">Imported</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600"><%= @import_batch.updated_count || 0 %></div>
            <div class="text-sm text-gray-600">Updated</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-red-600"><%= @import_batch.error_count || 0 %></div>
            <div class="text-sm text-gray-600">Errors</div>
          </div>
        </div>

        <% if @import_batch.total_rows && @import_batch.total_rows > 0 %>
          <div class="mt-4">
            <div class="text-sm text-gray-600 mb-2">Success Rate</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: <%= @import_batch.success_rate %>%"></div>
            </div>
            <div class="text-sm text-gray-600 mt-1"><%= @import_batch.success_rate %>%</div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="lg:col-span-1">
    <div class="card">
      <div class="card-header">
        <h3 class="text-lg font-semibold">Actions</h3>
      </div>
      <div class="card-body">
        <div class="space-y-3">
          <% if @import_batch.processing? %>
            <%= link_to status_admin_import_path(@import_batch), class: "flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors" do %>
              <div class="icon icon-chart text-blue-600 mr-3"></div>
              <div>
                <p class="font-medium text-blue-900">Check Status</p>
                <p class="text-sm text-blue-600">View current progress</p>
              </div>
            <% end %>
          <% end %>

          <% if @import_batch.error_count && @import_batch.error_count > 0 %>
            <%= link_to download_errors_admin_import_path(@import_batch), class: "flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 transition-colors" do %>
              <div class="icon icon-download text-red-600 mr-3"></div>
              <div>
                <p class="font-medium text-red-900">Download Errors</p>
                <p class="text-sm text-red-600">Get error report CSV</p>
              </div>
            <% end %>
          <% end %>

          <% if @import_batch.imported_count && @import_batch.imported_count > 0 %>
            <%= link_to download_processed_admin_import_path(@import_batch), class: "flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors" do %>
              <div class="icon icon-download text-green-600 mr-3"></div>
              <div>
                <p class="font-medium text-green-900">Download Processed</p>
                <p class="text-sm text-green-600">Get successfully imported data</p>
              </div>
            <% end %>
          <% end %>

          <%= link_to admin_import_path(@import_batch), method: :delete, 
              data: { confirm: "Are you sure you want to delete this import batch? This action cannot be undone." },
              class: "flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors" do %>
            <div class="icon icon-trash text-gray-600 mr-3"></div>
            <div>
              <p class="font-medium text-gray-900">Delete Import</p>
              <p class="text-sm text-gray-600">Remove this import batch</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- File Information -->
    <div class="card mt-6">
      <div class="card-header">
        <h3 class="text-lg font-semibold">File Information</h3>
      </div>
      <div class="card-body">
        <div class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-600">File Size</span>
            <span class="font-medium">
              <%= @import_batch.csv_file.attached? ? number_to_human_size(@import_batch.csv_file.byte_size) : "Unknown" %>
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Encoding</span>
            <span class="font-medium">UTF-8</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Format</span>
            <span class="font-medium">CSV</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
