<% content_for :page_title, "Import Batches" %>

<div class="admin-header">
  <div>
    <h1 class="admin-title">Import Batches</h1>
    <p class="admin-subtitle">Manage CSV import operations</p>
  </div>
  <div class="admin-actions">
    <%= link_to "New Import", new_admin_import_path, class: "btn btn-primary" %>
  </div>
</div>

<!-- Import Batches Table -->
<div class="admin-table-container">
  <table class="admin-table">
    <thead>
      <tr>
        <th>Filename</th>
        <th>User</th>
        <th>Status</th>
        <th>Progress</th>
        <th>Records</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @import_batches.each do |batch| %>
        <tr>
          <td>
            <div class="flex items-center">
              <div class="icon icon-upload text-gray-400 mr-2"></div>
              <div>
                <div class="font-medium text-gray-900"><%= batch.original_filename %></div>
                <% if batch.error_details.present? %>
                  <div class="text-sm text-red-600">Error: <%= truncate(batch.error_details, length: 50) %></div>
                <% end %>
              </div>
            </div>
          </td>
          <td>
            <span class="text-sm text-gray-600"><%= batch.user.email %></span>
          </td>
          <td>
            <span class="badge badge-<%= 
              case batch.status
              when 'completed' then 'success'
              when 'failed' then 'danger'
              when 'importing', 'validating', 'mapping' then 'warning'
              else 'secondary'
              end
            %>">
              <%= batch.status.humanize %>
            </span>
          </td>
          <td>
            <% if batch.processing? %>
              <div class="progress-bar">
                <div class="progress-fill" style="width: <%= batch.progress_percentage %>%"></div>
              </div>
              <span class="text-xs text-gray-600"><%= batch.progress_percentage %>%</span>
            <% elsif batch.completed? %>
              <span class="text-sm text-gray-600">100%</span>
            <% else %>
              <span class="text-sm text-gray-600">-</span>
            <% end %>
          </td>
          <td>
            <div class="text-sm">
              <% if batch.total_rows && batch.total_rows > 0 %>
                <div class="text-gray-900"><%= batch.total_rows %> total</div>
                <% if batch.imported_count && batch.imported_count > 0 %>
                  <div class="text-green-600"><%= batch.imported_count %> imported</div>
                <% end %>
                <% if batch.error_count && batch.error_count > 0 %>
                  <div class="text-red-600"><%= batch.error_count %> errors</div>
                <% end %>
              <% else %>
                <span class="text-gray-500">-</span>
              <% end %>
            </div>
          </td>
          <td>
            <span class="text-sm text-gray-600"><%= batch.created_at.strftime("%b %d, %Y") %></span>
          </td>
          <td>
            <div class="action-buttons">
              <%= link_to admin_import_path(batch), class: "btn btn-sm btn-outline", title: "View" do %>
                <div class="icon icon-eye"></div>
              <% end %>
              <% if batch.processing? %>
                <%= link_to status_admin_import_path(batch), class: "btn btn-sm btn-outline", title: "Check Status" do %>
                  <div class="icon icon-chart"></div>
                <% end %>
              <% end %>
              <% if batch.error_count && batch.error_count > 0 %>
                <%= link_to download_errors_admin_import_path(batch), class: "btn btn-sm btn-outline", title: "Download Errors" do %>
                  <div class="icon icon-download"></div>
                <% end %>
              <% end %>
              <%= link_to admin_import_path(batch), method: :delete, 
                  class: "btn btn-sm btn-danger", 
                  title: "Delete",
                  data: { confirm: "Are you sure you want to delete this import batch?" } do %>
                <div class="icon icon-trash"></div>
              <% end %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Pagination -->
<% if @total_pages > 1 %>
  <div class="admin-pagination">
    <div class="pagination-info">
      Showing <%= (@page - 1) * @per_page + 1 %>-<%= [@page * @per_page, @total_count].min %> of <%= @total_count %> import batches
    </div>
    <div class="pagination-controls">
      <% if @page > 1 %>
        <%= link_to admin_imports_path(page: @page - 1), class: "btn btn-sm btn-outline" do %>
          Previous
        <% end %>
      <% end %>
      
      <span class="px-3 py-1 text-sm text-gray-600">
        Page <%= @page %> of <%= @total_pages %>
      </span>
      
      <% if @page < @total_pages %>
        <%= link_to admin_imports_path(page: @page + 1), class: "btn btn-sm btn-outline" do %>
          Next
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<% if @import_batches.empty? %>
  <div class="text-center py-12">
    <div class="icon icon-upload icon-3xl text-gray-400 mx-auto mb-4"></div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No import batches found</h3>
    <p class="text-gray-600 mb-4">Get started by uploading your first CSV file.</p>
    <%= link_to "New Import", new_admin_import_path, class: "btn btn-primary" %>
  </div>
<% end %>
