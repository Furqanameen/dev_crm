<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Map CSV Columns</h2>
        <%= link_to "Back to Imports", admin_imports_path, class: "btn btn-secondary" %>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-file-csv me-2"></i>
            <%= @import_batch.original_filename %>
          </h5>
          <small class="text-muted">
            Total rows: <%= @import_batch.total_rows %>
          </small>
        </div>
        
        <div class="card-body">
          <p class="text-muted mb-4">
            Map the columns from your CSV file to the corresponding fields in our system.
          </p>

          <%= form_with url: preview_admin_import_path(@import_batch), data: { turbo_method: :post }, local: true do |form| %>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>CSV Column</th>
                    <th>Map to Field</th>
                    <th>Sample Data</th>
                  </tr>
                </thead>
                <tbody>
                  <% @headers.each_with_index do |header, index| %>
                    <tr>
                      <td>
                        <strong><%= header %></strong>
                      </td>
                      <td>
                        <%= select_tag "column_mapping[#{header}]", 
                            options_for_select([['-- Skip this column --', '']] + 
                            @available_fields.map { |field| [field.humanize, field] }, 
                            @suggested_mapping[header]),
                            class: "form-select" %>
                      </td>
                      <td class="text-muted">
                        <% if @import_batch.preview_rows(1).first %>
                          <%= truncate(@import_batch.preview_rows(1).first[header].to_s, length: 30) %>
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <%= link_to "Back", admin_import_path(@import_batch), class: "btn btn-secondary" %>
              <%= submit_tag "Preview Import", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
